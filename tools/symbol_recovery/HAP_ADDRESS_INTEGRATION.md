# HAP åœ°å€è§£æé›†æˆè¯´æ˜

## æ¦‚è¿°

å·²å°† HAP åœ°å€è§£æåŠŸèƒ½é›†æˆåˆ°ç¬¦å·æ¢å¤æµç¨‹ä¸­ï¼Œè‡ªåŠ¨å¤„ç† `entry.hap+0x...` æˆ– `entry.hap@0x...` æ ¼å¼çš„åœ°å€ã€‚

## åŠŸèƒ½

### 1. è‡ªåŠ¨æ£€æµ‹ HAP åœ°å€

åœ¨ä» `perf.db` æå–ç¼ºå¤±ç¬¦å·æ—¶ï¼Œè‡ªåŠ¨æ£€æµ‹ HAP åœ°å€ï¼š

```python
# è‡ªåŠ¨æ£€æµ‹
if is_hap_address(address):
    # è¿™æ˜¯ HAP åœ°å€ï¼Œéœ€è¦è§£æ
```

### 2. æ‰¹é‡è§£æ HAP åœ°å€

åœ¨ `_get_missing_symbols_from_perf_db` ä¸­ï¼š

1. **æ£€æµ‹é˜¶æ®µ**ï¼šæ”¶é›†æ‰€æœ‰ HAP åœ°å€
2. **æ‰¹é‡è§£æ**ï¼šä½¿ç”¨ `resolve_hap_addresses_batch` ä¸€æ¬¡æ€§è§£ææ‰€æœ‰ HAP åœ°å€
3. **åœ°å€è½¬æ¢**ï¼šå°† HAP åœ°å€è½¬æ¢ä¸º SO æ–‡ä»¶åœ°å€æ ¼å¼

```python
# ç¤ºä¾‹è½¬æ¢
entry.hap+0x4bc171c -> libquick.so+0x4bc171c
```

### 3. è‡ªåŠ¨å¤„ç†æµç¨‹

#### æ‰¹é‡åˆ†ææ¨¡å¼

1. ä» `perf.db` æå–ç¼ºå¤±ç¬¦å·
2. æ£€æµ‹å¹¶æ‰¹é‡è§£æ HAP åœ°å€
3. è½¬æ¢ä¸º SO æ–‡ä»¶åœ°å€
4. ç»§ç»­æ­£å¸¸çš„åˆ†ææµç¨‹ï¼ˆåæ±‡ç¼–ã€LLM åˆ†æç­‰ï¼‰

#### å•ä¸ªåˆ†ææ¨¡å¼

1. å¦‚æœ HAP åœ°å€åœ¨æ‰¹é‡è§£æé˜¶æ®µæœªæˆåŠŸè§£æ
2. åœ¨åˆ†æå‡½æ•°æ—¶å†æ¬¡å°è¯•è§£æ
3. å¦‚æœè§£ææˆåŠŸï¼Œä½¿ç”¨è½¬æ¢åçš„åœ°å€è¿›è¡Œåˆ†æ
4. å¦‚æœè§£æå¤±è´¥ï¼Œè·³è¿‡è¯¥åœ°å€

## ä½¿ç”¨æ–¹å¼

### è‡ªåŠ¨é›†æˆ

æ— éœ€é¢å¤–é…ç½®ï¼ŒHAP åœ°å€è§£æå·²è‡ªåŠ¨é›†æˆåˆ°ç°æœ‰æµç¨‹ä¸­ï¼š

```bash
# æ­£å¸¸ä½¿ç”¨ç¬¦å·æ¢å¤å·¥å…·
python3 main.py --perf-db perf.db --so-dir ./so_files --top-n 100
```

### æ—¥å¿—è¾“å‡º

è§£æè¿‡ç¨‹ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼š

```
æ­¥éª¤ 3: æ‰¹é‡è§£æ 5 ä¸ª HAP åœ°å€...
âœ… æ‰¾åˆ° 5 ä¸ªåœ°å€çš„ data_dict æ˜ å°„
âœ… æ‰¹é‡è§£æå®Œæˆï¼ŒæˆåŠŸè§£æ 4/5 ä¸ªåœ°å€
  âœ… entry.hap+0x4bc171c -> libquick.so+0x4bc171c
  âœ… entry.hap+0x4bc1dea -> libquick.so+0x4bc1dea
  âš ï¸  entry.hap+0x4bc1e98 æœªæ‰¾åˆ°å¯¹åº”çš„ SO æ–‡ä»¶
ğŸ“Š HAP åœ°å€ç»Ÿè®¡: å…± 5 ä¸ªï¼ŒæˆåŠŸè§£æ 4 ä¸ª
```

## æŠ€æœ¯å®ç°

### æ¨¡å—ç»“æ„

```
core/utils/hap_address_resolver.py
â”œâ”€â”€ is_hap_address()          # åˆ¤æ–­æ˜¯å¦æ˜¯ HAP åœ°å€
â”œâ”€â”€ parse_hap_address()        # è§£æ HAP åœ°å€å­—ç¬¦ä¸²
â”œâ”€â”€ resolve_hap_address_from_perfdb()  # å•ä¸ªåœ°å€è§£æ
â””â”€â”€ resolve_hap_addresses_batch()      # æ‰¹é‡åœ°å€è§£æ
```

### é›†æˆç‚¹

1. **`perf_converter.py`**:
   - `_get_missing_symbols_from_perf_db()`: æ‰¹é‡è§£æ HAP åœ°å€
   - `analyze_top_functions()`: å•ä¸ªåˆ†ææ¨¡å¼ä¸‹çš„ HAP åœ°å€å¤„ç†

### è§£æç­–ç•¥

1. **ä» perf.db æŸ¥è¯¢**:
   - æŸ¥æ‰¾ `entry.hap` æ–‡ä»¶çš„ `file_id`
   - æŸ¥æ‰¾ `data_dict` ä¸­çš„åœ°å€æ˜ å°„
   - é€šè¿‡è°ƒç”¨é“¾æ‰¾åˆ°ç›¸å…³çš„ SO æ–‡ä»¶

2. **åœ°å€è½¬æ¢**:
   - HAP åç§»é‡ â†’ SO æ–‡ä»¶åç§»é‡ï¼ˆç›®å‰ä½¿ç”¨ç›¸åŒåç§»é‡ï¼‰
   - æ›´æ–° `file_path` å’Œ `address` å­—æ®µ

3. **é”™è¯¯å¤„ç†**:
   - å¦‚æœè§£æå¤±è´¥ï¼Œä¿ç•™åŸå§‹åœ°å€
   - åœ¨åˆ†æé˜¶æ®µå†æ¬¡å°è¯•è§£æ
   - å¦‚æœä»ç„¶å¤±è´¥ï¼Œè·³è¿‡è¯¥åœ°å€

## æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡æŸ¥è¯¢

- ä½¿ç”¨ä¸€æ¬¡æ•°æ®åº“è¿æ¥æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰åœ°å€
- é¿å… N+1 æŸ¥è¯¢é—®é¢˜
- å¿«é€Ÿæ¨¡å¼ï¼ˆ`quick_mode=True`ï¼‰è·³è¿‡è°ƒç”¨é“¾ä¸Šä¸‹æ–‡

### ç¼“å­˜æœºåˆ¶

- è§£æç»“æœä¿å­˜åœ¨ `item['hap_resolution']` ä¸­
- é¿å…é‡å¤è§£æåŒä¸€ä¸ªåœ°å€

## é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

### å½“å‰é™åˆ¶

1. **åç§»é‡è½¬æ¢**ï¼šç›®å‰ HAP åç§»é‡ç›´æ¥ç”¨ä½œ SO æ–‡ä»¶åç§»é‡ï¼Œå¯èƒ½éœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
2. **SO æ–‡ä»¶æŸ¥æ‰¾**ï¼šé€šè¿‡è°ƒç”¨é“¾æŸ¥æ‰¾ SO æ–‡ä»¶ï¼Œå¦‚æœè°ƒç”¨é“¾ä¸­æ²¡æœ‰ç›¸å…³ SO æ–‡ä»¶ï¼Œè§£æä¼šå¤±è´¥
3. **ç³»ç»Ÿåº“è¿‡æ»¤**ï¼šè‡ªåŠ¨è¿‡æ»¤ç³»ç»Ÿåº“ï¼ˆ`/system/`, `/vendor/`, `/lib/`ï¼‰ï¼ŒåªæŸ¥æ‰¾åº”ç”¨å†…çš„ SO æ–‡ä»¶

### æœªæ¥æ”¹è¿›

1. **åç§»é‡æ˜ å°„**ï¼šå®ç° HAP åç§»é‡åˆ° SO æ–‡ä»¶åç§»é‡çš„ç²¾ç¡®æ˜ å°„
2. **å¤šç§æŸ¥æ‰¾ç­–ç•¥**ï¼šå¦‚æœè°ƒç”¨é“¾ä¸­æ‰¾ä¸åˆ°ï¼Œå°è¯•å…¶ä»–æŸ¥æ‰¾ç­–ç•¥
3. **å†…å­˜æ˜ å°„æ”¯æŒ**ï¼šæ”¯æŒå†…å­˜æ˜ å°„åœ°å€çš„è§£æï¼ˆéœ€è¦ `/proc/{pid}/maps`ï¼‰

## æµ‹è¯•

### æµ‹è¯• HAP åœ°å€æ£€æµ‹

```python
from core.utils.hap_address_resolver import is_hap_address

assert is_hap_address('entry.hap+0x4bc171c') == True
assert is_hap_address('entry.hap@0x4bc171c') == True
assert is_hap_address('libquick.so+0x4bc171c') == False
```

### æµ‹è¯•åœ°å€è§£æ

```python
from core.utils.hap_address_resolver import resolve_hap_address_from_perfdb
from pathlib import Path

perf_db = Path('perf.db')
result = resolve_hap_address_from_perfdb(perf_db, 'entry.hap+0x4bc171c')
if result and result.get('resolved'):
    print(f"SO æ–‡ä»¶: {result['so_name']}")
    print(f"åç§»é‡: 0x{result['so_offset']:x}")
```

## ç›¸å…³æ–‡ä»¶

- `core/utils/hap_address_resolver.py`: HAP åœ°å€è§£ææ¨¡å—
- `core/utils/perf_converter.py`: ç¬¦å·æ¢å¤ä¸»æµç¨‹ï¼ˆå·²é›†æˆï¼‰
- `query_hap_address_from_perfdb.py`: ç‹¬ç«‹çš„ HAP åœ°å€æŸ¥è¯¢å·¥å…·ï¼ˆç”¨äºè°ƒè¯•ï¼‰

## ä½¿ç”¨ç¤ºä¾‹

### æ­£å¸¸ä½¿ç”¨

```bash
# è¿è¡Œç¬¦å·æ¢å¤ï¼Œè‡ªåŠ¨å¤„ç† HAP åœ°å€
python3 main.py \
  --perf-db data/perf.db \
  --so-dir data/so_files \
  --top-n 100 \
  --use-llm \
  --use-batch-llm
```

### è°ƒè¯• HAP åœ°å€

```bash
# ä½¿ç”¨ç‹¬ç«‹å·¥å…·æŸ¥è¯¢ HAP åœ°å€
python3 query_hap_address_from_perfdb.py \
  data/perf.db \
  entry.hap+0x4bc171c \
  --quick
```

## æ€»ç»“

HAP åœ°å€è§£æå·²å®Œå…¨é›†æˆåˆ°ç¬¦å·æ¢å¤æµç¨‹ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®å³å¯è‡ªåŠ¨å¤„ç† HAP åœ°å€ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š

1. æ£€æµ‹ HAP åœ°å€
2. æ‰¹é‡è§£æä¸º SO æ–‡ä»¶åœ°å€
3. ç»§ç»­æ­£å¸¸çš„åˆ†ææµç¨‹

å¦‚æœè§£æå¤±è´¥ï¼Œä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºè­¦å‘Šï¼Œå¹¶è·³è¿‡è¯¥åœ°å€ã€‚

