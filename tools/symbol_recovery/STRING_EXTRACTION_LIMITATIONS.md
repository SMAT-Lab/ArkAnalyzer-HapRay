# 字符串常量提取限制说明

## 问题：字符串常量经常找不到

这是**正常现象**，原因如下：

## 为什么字符串常量可能找不到

### 1. 函数特性

很多函数确实不引用字符串常量，这是正常的：

- **纯计算函数**：只进行数学运算、位操作等，不涉及字符串
- **内存操作函数**：memcpy, memset 等，不涉及字符串常量
- **系统调用包装**：直接调用系统调用，不涉及字符串
- **内联函数**：可能被编译器优化，字符串引用被内联

### 2. 字符串引用方式限制

当前实现只支持以下 ARM64 指令模式：

- ✅ **adrp + add 指令对**：最常见的字符串引用方式
  ```asm
  adrp x0, #0x1234000
  add  x0, x0, #0x567
  ```

- ✅ **adr 指令**：相对地址引用
  ```asm
  adr x0, #0x1234
  ```

- ✅ **ldr 指令中的立即数**：直接加载
  ```asm
  ldr x0, [x1, #0x1234]
  ```

- ❌ **不支持的方式**：
  - 间接引用（通过全局变量）
  - 动态加载（运行时计算地址）
  - 字符串池引用
  - 其他架构特定的引用方式

### 3. 段查找限制

- 只查找 `.rodata` 和 `.data` 段
- 如果字符串在其他段（如 `.text`, `.bss`），无法找到
- 如果 SO 文件没有 `.rodata` 段，无法提取

### 4. 提取逻辑限制

- **最小长度**：字符串至少 4 个字符
- **字符类型**：只提取可打印 ASCII 字符（32-126）
- **数量限制**：最多返回 10 个字符串（精准提取）或 5 个（fallback）
- **过滤机制**：错误消息和调试字符串会被过滤

### 5. 编译器优化

- **字符串合并**：编译器可能将多个相同字符串合并为一个
- **字符串内联**：短字符串可能被内联到代码中
- **死代码消除**：未使用的字符串可能被优化掉

## 当前实现策略

### 方法 1：精准提取（主要方法）

通过分析反汇编指令，查找字符串引用：

1. 分析 `adrp`/`add`/`adr`/`ldr` 指令
2. 计算字符串地址
3. 从 `.rodata` 或 `.data` 段提取字符串

**优点**：精准，只提取函数实际引用的字符串  
**缺点**：依赖指令模式，可能遗漏

### 方法 2：Fallback 方法

如果精准提取失败，扫描整个 `.rodata` 段：

1. 扫描 `.rodata` 段的前 10KB
2. 提取所有可打印字符串
3. 限制数量（最多 5 个）

**优点**：即使指令分析失败也能找到一些字符串  
**缺点**：可能提取到不相关的字符串

### 方法 3：Radare2 交叉引用（如果使用 radare2）

使用 radare2 的交叉引用功能：

1. 使用 `izj` 获取所有字符串
2. 使用 `axtj` 查找函数内的引用
3. 过滤和验证

**优点**：更全面，能发现间接引用  
**缺点**：需要 radare2，可能较慢

## 改进建议

### 短期改进（已实现）

1. ✅ **添加过滤机制**：过滤错误消息和调试字符串
2. ✅ **改进 fallback 方法**：在函数附近搜索字符串
3. ✅ **增强日志**：明确说明为什么找不到字符串

### 长期改进（可选）

1. **支持更多指令模式**：
   - `ldr` 指令的变体
   - `mov` 指令中的立即数
   - 其他架构特定的引用方式

2. **改进地址计算**：
   - 跟踪寄存器值
   - 处理间接引用
   - 支持字符串池

3. **扩大搜索范围**：
   - 搜索更多段（`.text`, `.bss` 等）
   - 扩大函数附近的搜索范围
   - 使用更智能的启发式方法

4. **使用符号表**：
   - 如果 SO 文件有符号表，可以直接查找字符串符号
   - 使用 `strings` 工具作为补充

## 结论

**字符串常量经常找不到是正常现象**，因为：

1. 很多函数确实不引用字符串常量
2. 字符串引用方式多样，当前实现只支持部分方式
3. 编译器优化可能影响字符串的可见性

**当前实现已经尽力提取字符串**，如果找不到，通常意味着：
- 函数确实不引用字符串常量（正常）
- 字符串通过不支持的方式引用（需要改进提取逻辑）
- 字符串被编译器优化或内联（无法提取）

**建议**：
- 如果字符串对分析很重要，可以手动检查反汇编代码
- 或者使用 `strings` 工具扫描整个 SO 文件
- 或者改进提取逻辑，支持更多引用方式

