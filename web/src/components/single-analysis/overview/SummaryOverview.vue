<template>
  <div class="summary-overview-container">
    <div class="summary-header">
      <h2>åˆ†ææ€»ç»“</h2>
      <p class="summary-desc">
        æ±‡æ€»å„æ­¥éª¤çš„å…³é”®æ•…éšœç±»ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç»„ä»¶å¤ç”¨ã€æ•…éšœæ ‘è¯†åˆ«ç»“æœã€Image è¶…å°ºå¯¸ç»Ÿè®¡ä»¥åŠç»„ä»¶æ ‘ä¸Š/æœªä¸Šæ ‘èŠ‚ç‚¹æƒ…å†µã€‚
      </p>
    </div>

    <!-- åˆ¤æ–­è§„åˆ™è¯´æ˜ -->
    <el-card class="rules-card" shadow="never">
      <template #header>
        <div class="rules-header">
          <span>ğŸ“‹ é—®é¢˜åˆ¤æ–­è§„åˆ™è¯´æ˜</span>
          <el-button text type="primary" size="small" @click="showRules = !showRules">
            {{ showRules ? 'æ”¶èµ·' : 'å±•å¼€' }}
          </el-button>
        </div>
      </template>
      <div v-show="showRules" class="rules-content">
        <div class="rule-item">
          <strong>ç©ºåˆ·å¸§å æ¯”ï¼š</strong>
          <span>å æ¯” > 10% æ—¶æ˜¾ç¤ºï¼Œ> 50% ä¸ºä¸¥é‡ï¼Œ10-50% ä¸ºä¸­ç­‰</span>
        </div>

        <div class="rule-section">
          <strong class="rule-section-title">æ•…éšœæ ‘æŒ‡æ ‡ï¼š</strong>
          <div class="rule-subsection">
            <div class="rule-subtitle">åˆ¤æ–­è§„åˆ™ï¼šè¶…è¿‡é¢„è®¾é˜ˆå€¼æ—¶æ˜¾ç¤ºï¼Œè¶…è¿‡é˜ˆå€¼ 2 å€ä¸ºä¸¥é‡ï¼Œå¦åˆ™ä¸ºä¸­ç­‰</div>
            
            <div class="rule-category">
              <strong>ğŸ¨ ArkUI æ•…éšœåˆ†æï¼š</strong>
              <ul class="rule-list">
                <li>å¸§åŠ¨ç”»æ•°é‡ï¼šé˜ˆå€¼ 50 ä¸ª</li>
                <li>åŒºåŸŸå˜åŒ–ç›‘å¬ï¼šé˜ˆå€¼ 1000 æ¬¡</li>
                <li>å¯è§åŒºåŸŸå˜åŒ–ç›‘å¬ï¼šé˜ˆå€¼ 1000 æ¬¡</li>
                <li>å±å¹•å®½é«˜è·å–ï¼šé˜ˆå€¼ 100 æ¬¡</li>
                <li>äº‹åŠ¡æ•°æ®åºåˆ—åŒ–ï¼šé˜ˆå€¼ 3000 æ¬¡</li>
                <li>è½¯è§£ç ï¼šæ£€æµ‹åˆ°ä½¿ç”¨è½¯è§£ç å™¨æ—¶æ˜¾ç¤ºï¼ˆä¸­ç­‰ï¼‰</li>
              </ul>
            </div>

            <div class="rule-category">
              <strong>ğŸ–¼ï¸ RS æ¸²æŸ“æœåŠ¡æ•…éšœåˆ†æï¼š</strong>
              <ul class="rule-list">
                <li>å¤„ç†èŠ‚ç‚¹æ•°ï¼šé˜ˆå€¼ 200 ä¸ª</li>
                <li>å¤„ç†æ—¶é—´ï¼šé˜ˆå€¼ 5 ç§’</li>
                <li>èŠ‚ç‚¹è·³è¿‡æ¬¡æ•°ï¼šé˜ˆå€¼ 10 æ¬¡</li>
                <li>ååºåˆ—åŒ–æ•°é‡ï¼šé˜ˆå€¼ 60 æ¬¡</li>
                <li>åŠ¨ç”»èŠ‚ç‚¹æ€»å¤§å°ï¼šé˜ˆå€¼ 1000ï¼ˆå•ä½ï¼šæ¸²æŸ“æœåŠ¡å†…éƒ¨å•ä½ï¼‰</li>
                <li>åŠ¨ç”»æ€»å¤§å°ï¼šé˜ˆå€¼ 2000ï¼ˆå•ä½ï¼šæ¸²æŸ“æœåŠ¡å†…éƒ¨å•ä½ï¼‰</li>
              </ul>
            </div>

            <div class="rule-category">
              <strong>ğŸ¬ éŸ³è§†é¢‘ç¼–è§£ç æ•…éšœåˆ†æï¼š</strong>
              <ul class="rule-list">
                <li>æ’­æ§æŒ‡ä»¤æ•°ï¼šé˜ˆå€¼ 1,000,000 æ¬¡</li>
                <li>è§†é¢‘è§£ç è¾“å…¥å¸§ï¼šé˜ˆå€¼ 300 å¸§</li>
                <li>è§†é¢‘è§£ç æ¶ˆè´¹å¸§ï¼šé˜ˆå€¼ 250 å¸§</li>
              </ul>
            </div>

            <div class="rule-category">
              <strong>ğŸ”Š éŸ³é¢‘æ•…éšœåˆ†æï¼š</strong>
              <ul class="rule-list">
                <li>éŸ³é¢‘å†™å›è°ƒï¼šé˜ˆå€¼ 5,000,000 æ¬¡</li>
                <li>éŸ³é¢‘è¯»å›è°ƒï¼šé˜ˆå€¼ 1,000,000 æ¬¡</li>
                <li>éŸ³é¢‘æ’­æ”¾å›è°ƒï¼šé˜ˆå€¼ 1,000,000 æ¬¡</li>
                <li>éŸ³é¢‘å½•åˆ¶å›è°ƒï¼šé˜ˆå€¼ 1,000,000 æ¬¡</li>
              </ul>
            </div>

            <div class="rule-category">
              <strong>ğŸ”— IPC Binder è¿›ç¨‹é—´é€šä¿¡æ•…éšœåˆ†æï¼š</strong>
              <ul class="rule-list">
                <li>æ€»é€šä¿¡æ¬¡æ•°ï¼šé˜ˆå€¼ 10,000 æ¬¡</li>
                <li>é«˜å»¶è¿Ÿé€šä¿¡æ¬¡æ•°ï¼šé˜ˆå€¼ 10 æ¬¡</li>
                <li>å¹³å‡å»¶è¿Ÿï¼šé˜ˆå€¼ 50 ms</li>
                <li>æœ€å¤§å»¶è¿Ÿï¼šé˜ˆå€¼ 100 ms</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="rule-item">
          <strong>Image è¶…å°ºå¯¸ï¼š</strong>
          <span>è¶…å°ºå¯¸æ•°é‡ > 0 æˆ–é¢å¤–å†…å­˜ > 10MB æ—¶æ˜¾ç¤ºï¼Œé¢å¤–å†…å­˜ > 50MB ä¸ºä¸¥é‡ï¼Œå¦åˆ™ä¸ºä¸­ç­‰</span>
        </div>
        <div class="rule-item">
          <strong>ç»„ä»¶æœªä¸Šæ ‘ï¼š</strong>
          <span>æœªä¸Šæ ‘å æ¯” > 20% æ—¶æ˜¾ç¤ºï¼Œ> 50% ä¸ºä¸¥é‡ï¼Œ20-50% ä¸ºä¸­ç­‰</span>
        </div>
        <div class="rule-item">
          <strong>ç»„ä»¶å¤ç”¨ç‡ï¼š</strong>
          <span>å¤ç”¨ç‡ < 30% ä¸”æ€»æ„å»º > 0 æ—¶æ˜¾ç¤ºï¼Œ< 10% ä¸ºä¸¥é‡ï¼Œ10-30% ä¸ºä¸­ç­‰</span>
        </div>
        <div class="rule-item">
          <strong>æŠ€æœ¯æ ˆä¸æ—¥å¿—ï¼š</strong>
          <span>ä¸åœ¨æ­¤é¡µé¢æ˜¾ç¤º</span>
        </div>
      </div>
    </el-card>

    <!-- æ­¥éª¤å¯¼èˆª -->
    <div v-if="summaryItems.length" class="step-nav">
      <span class="step-nav-label">æ­¥éª¤å¯¼èˆªï¼š</span>
      <el-button
        v-for="item in summaryItems"
        :key="item.step_id"
        size="small"
        round
        @click="scrollToStep(getStepIndex(item.step_id) as number)"
      >
        æ­¥éª¤ {{ getStepIndex(item.step_id) }}
      </el-button>
    </div>

    <!-- æ— æ•°æ®æç¤º -->
    <el-empty
      v-if="!summaryItems.length"
      description="å½“å‰æŠ¥å‘ŠæœªåŒ…å«åˆ†ææ€»ç»“æ•°æ®ï¼Œè¯·ç¡®è®¤ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ hapray ç”ŸæˆæŠ¥å‘Šã€‚"
      class="summary-empty"
    />

    <!-- æ¯ä¸ªæ­¥éª¤çš„è¡¨æ ¼ -->
    <div
      v-for="item in summaryItems"
      :key="item.step_id"
      class="step-section"
      :id="'summary-step-' + getStepIndex(item.step_id)"
    >
      <div class="step-header">
        <span class="step-tag">æ­¥éª¤ {{ getStepIndex(item.step_id) }}</span>
        <span class="step-name">{{ getStepName(item.step_id) }}</span>
      </div>

      <el-table
        :data="getIssuesForStep(item)"
        stripe
        border
        style="width: 100%"
        :empty-text="'å½“å‰æ­¥éª¤æœªæ£€æµ‹åˆ°éœ€è¦å…³æ³¨çš„é—®é¢˜'"
      >
        <el-table-column prop="issue" label="Issueåç§°" width="200" />
        <el-table-column prop="detail" label="è¯¦æƒ…" min-width="300" />
        <el-table-column prop="severity" label="ä¸¥é‡ç¨‹åº¦" width="120" align="center">
          <template #default="{ row }">
            <el-tag :type="getSeverityType(row.severity)" size="small">
              {{ row.severity }}
            </el-tag>
          </template>
        </el-table-column>
      </el-table>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, ref } from 'vue';
import { useJsonDataStore } from '@/stores/jsonDataStore.ts';

interface SummaryItem {
  step_id: string;
  report_html_path?: string;
  empty_frame?: {
    count?: number;
    percentage?: string;
  };
  tech_stack?: Record<string, number>;
  log?: Record<string, unknown>;
  component_reuse?: {
    total_builds?: number;
    recycled_builds?: number;
    reusability_ratio?: number;
    max_component?: string;
  };
  fault_tree?: Record<string, unknown>;
  image_oversize?: {
    total_images?: number;
    exceed_count?: number;
    total_excess_memory_mb?: number;
  };
  component_tree?: {
    total_nodes?: number;
    on_tree_nodes?: number;
    off_tree_nodes?: number;
    off_tree_ratio?: number;
  };
}

interface IssueRow {
  issue: string;
  detail: string;
  severity: 'ä¸¥é‡' | 'ä¸­ç­‰' | 'è½»å¾®';
}

const jsonDataStore = useJsonDataStore();

const summaryItems = computed<SummaryItem[]>(() => (jsonDataStore.summary ?? []) as SummaryItem[]);

const showRules = ref(true);

const emit = defineEmits<{
  pageChange: [page: string];
}>();

const stepNameMap = computed(() => {
  const map: Record<string, string> = {};
  const steps = jsonDataStore.steps || [];
  steps.forEach((step) => {
    const key = `step${step.step_id}`;
    map[key] = step.step_name;
  });
  return map;
});

const getStepIndex = (stepId: string) => {
  const match = stepId.match(/step(\d+)/);
  return match ? Number(match[1]) : stepId;
};

const getStepName = (stepId: string) => {
  return stepNameMap.value[stepId] ?? stepId;
};

const scrollToStep = (stepIndex: number) => {
  const el = document.getElementById(`summary-step-${stepIndex}`);
  if (el) {
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
};

// è§£æç™¾åˆ†æ¯”å­—ç¬¦ä¸²ä¸ºæ•°å­—
const parsePercentage = (percentageStr?: string): number => {
  if (!percentageStr) return 0;
  const match = percentageStr.match(/(\d+\.?\d*)/);
  return match ? parseFloat(match[1]) : 0;
};

// æ•…éšœæ ‘é˜ˆå€¼ï¼ˆä¸ FaultTreeAnalysis.vue ä¿æŒä¸€è‡´ï¼‰
const FAULT_THRESHOLDS: Array<{
  path: string[];
  issueName: string; // æ¸…æ™°çš„issueåç§°
  description: string; // è¯¦ç»†è¯´æ˜
  threshold: number;
  format?: (v: number) => string;
}> = [
  {
    path: ['arkui', 'animator'],
    issueName: 'ArkUI å¸§åŠ¨ç”»æ•°é‡è¿‡å¤š',
    description: 'ArkUI æ¡†æ¶ä¸­åˆ›å»ºçš„å¸§åŠ¨ç”»æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜',
    threshold: 50,
  },
  {
    path: ['arkui', 'HandleOnAreaChangeEvent'],
    issueName: 'ArkUI åŒºåŸŸå˜åŒ–ç›‘å¬è¿‡å¤š',
    description: 'åŒºåŸŸå˜åŒ–äº‹ä»¶ç›‘å¬æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“æ¸²æŸ“æ€§èƒ½',
    threshold: 1000,
  },
  {
    path: ['arkui', 'HandleVisibleAreaChangeEvent'],
    issueName: 'ArkUI å¯è§åŒºåŸŸå˜åŒ–ç›‘å¬è¿‡å¤š',
    description: 'å¯è§åŒºåŸŸå˜åŒ–äº‹ä»¶ç›‘å¬æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“æ¸²æŸ“æ€§èƒ½',
    threshold: 1000,
  },
  {
    path: ['arkui', 'GetDefaultDisplay'],
    issueName: 'ArkUI å±å¹•å®½é«˜è·å–æ¬¡æ•°è¿‡å¤š',
    description: 'é¢‘ç¹è·å–å±å¹•å®½é«˜ä¿¡æ¯ï¼Œå¯èƒ½å½±å“æ€§èƒ½',
    threshold: 100,
  },
  {
    path: ['arkui', 'MarshRSTransactionData'],
    issueName: 'ArkUI äº‹åŠ¡æ•°æ®åºåˆ—åŒ–æ¬¡æ•°è¿‡å¤š',
    description: 'RS äº‹åŠ¡æ•°æ®åºåˆ—åŒ–æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“æ¸²æŸ“æ€§èƒ½',
    threshold: 3000,
  },
  {
    path: ['RS', 'ProcessedNodes', 'count'],
    issueName: 'RS æ¸²æŸ“æœåŠ¡å¤„ç†èŠ‚ç‚¹æ•°è¿‡å¤š',
    description: 'RS æ¸²æŸ“æœåŠ¡å¤„ç†çš„èŠ‚ç‚¹æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œå¯èƒ½å¯¼è‡´æ¸²æŸ“æ€§èƒ½é—®é¢˜',
    threshold: 200,
  },
  {
    path: ['RS', 'ProcessedNodes', 'ts'],
    issueName: 'RS æ¸²æŸ“æœåŠ¡å¤„ç†æ—¶é—´è¿‡é•¿',
    description: 'RS æ¸²æŸ“æœåŠ¡å¤„ç†èŠ‚ç‚¹çš„æ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼Œå¯èƒ½å¯¼è‡´å¸§ç‡ä¸‹é™',
    threshold: 5,
    format: (v) => v.toFixed(3),
  },
  {
    path: ['RS', 'DisplayNodeSkipTimes'],
    issueName: 'RS æ¸²æŸ“æœåŠ¡èŠ‚ç‚¹è·³è¿‡æ¬¡æ•°è¿‡å¤š',
    description: 'RS æ¸²æŸ“æœåŠ¡è·³è¿‡èŠ‚ç‚¹æ¸²æŸ“çš„æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“æ˜¾ç¤ºæ•ˆæœ',
    threshold: 10,
  },
  {
    path: ['RS', 'UnMarshRSTransactionData'],
    issueName: 'RS æ¸²æŸ“æœåŠ¡ååºåˆ—åŒ–æ¬¡æ•°è¿‡å¤š',
    description: 'RS äº‹åŠ¡æ•°æ®ååºåˆ—åŒ–æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“æ¸²æŸ“æ€§èƒ½',
    threshold: 60,
  },
  {
    path: ['RS', 'AnimateSize', 'nodeSizeSum'],
    issueName: 'RS æ¸²æŸ“æœåŠ¡åŠ¨ç”»èŠ‚ç‚¹æ€»å¤§å°è¿‡å¤§',
    description: 'RS æ¸²æŸ“æœåŠ¡ä¸­åŠ¨ç”»èŠ‚ç‚¹çš„æ€»å¤§å°è¶…è¿‡é˜ˆå€¼ï¼Œå¯èƒ½å½±å“æ€§èƒ½',
    threshold: 1000,
  },
  {
    path: ['RS', 'AnimateSize', 'totalAnimationSizeSum'],
    issueName: 'RS æ¸²æŸ“æœåŠ¡åŠ¨ç”»æ€»å¤§å°è¿‡å¤§',
    description: 'RS æ¸²æŸ“æœåŠ¡ä¸­æ‰€æœ‰åŠ¨ç”»çš„æ€»å¤§å°è¶…è¿‡é˜ˆå€¼ï¼Œå¯èƒ½å½±å“æ€§èƒ½',
    threshold: 2000,
  },
  {
    path: ['av_codec', 'BroadcastControlInstructions'],
    issueName: 'éŸ³è§†é¢‘æ’­æ§æŒ‡ä»¤æ•°è¿‡å¤š',
    description: 'éŸ³è§†é¢‘ç¼–è§£ç çš„æ’­æ§æŒ‡ä»¤æ•°é‡è¿‡å¤šï¼Œå¯èƒ½å½±å“æ’­æ”¾æ€§èƒ½',
    threshold: 1000000,
  },
  {
    path: ['av_codec', 'VideoDecodingInputFrameCount'],
    issueName: 'è§†é¢‘è§£ç è¾“å…¥å¸§æ•°è¿‡å¤š',
    description: 'è§†é¢‘è§£ç å™¨æ¥æ”¶çš„è¾“å…¥å¸§æ•°é‡è¿‡å¤šï¼Œå¯èƒ½å¯¼è‡´è§£ç æ€§èƒ½é—®é¢˜',
    threshold: 300,
  },
  {
    path: ['av_codec', 'VideoDecodingConsumptionFrame'],
    issueName: 'è§†é¢‘è§£ç æ¶ˆè´¹å¸§æ•°è¿‡å¤š',
    description: 'è§†é¢‘è§£ç å™¨æ¶ˆè´¹çš„å¸§æ•°é‡è¿‡å¤šï¼Œå¯èƒ½å¯¼è‡´è§£ç æ€§èƒ½é—®é¢˜',
    threshold: 250,
  },
  {
    path: ['Audio', 'AudioWriteCB'],
    issueName: 'éŸ³é¢‘å†™å›è°ƒæ¬¡æ•°è¿‡å¤š',
    description: 'éŸ³é¢‘å†™å›è°ƒå‡½æ•°è°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“éŸ³é¢‘æ’­æ”¾æ€§èƒ½',
    threshold: 5000000,
  },
  {
    path: ['Audio', 'AudioReadCB'],
    issueName: 'éŸ³é¢‘è¯»å›è°ƒæ¬¡æ•°è¿‡å¤š',
    description: 'éŸ³é¢‘è¯»å›è°ƒå‡½æ•°è°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“éŸ³é¢‘å½•åˆ¶æ€§èƒ½',
    threshold: 1000000,
  },
  {
    path: ['Audio', 'AudioPlayCb'],
    issueName: 'éŸ³é¢‘æ’­æ”¾å›è°ƒæ¬¡æ•°è¿‡å¤š',
    description: 'éŸ³é¢‘æ’­æ”¾å›è°ƒå‡½æ•°è°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“éŸ³é¢‘æ’­æ”¾æ€§èƒ½',
    threshold: 1000000,
  },
  {
    path: ['Audio', 'AudioRecCb'],
    issueName: 'éŸ³é¢‘å½•åˆ¶å›è°ƒæ¬¡æ•°è¿‡å¤š',
    description: 'éŸ³é¢‘å½•åˆ¶å›è°ƒå‡½æ•°è°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“éŸ³é¢‘å½•åˆ¶æ€§èƒ½',
    threshold: 1000000,
  },
  {
    path: ['ipc_binder', 'total_transactions'],
    issueName: 'IPC Binder è¿›ç¨‹é—´é€šä¿¡æ¬¡æ•°è¿‡å¤š',
    description: 'IPC Binder è¿›ç¨‹é—´é€šä¿¡çš„æ€»æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œå¯èƒ½å½±å“åº”ç”¨å“åº”æ€§èƒ½',
    threshold: 10000,
  },
  {
    path: ['ipc_binder', 'high_latency_count'],
    issueName: 'IPC Binder é«˜å»¶è¿Ÿé€šä¿¡æ¬¡æ•°è¿‡å¤š',
    description: 'IPC Binder é«˜å»¶è¿Ÿé€šä¿¡æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å¯¼è‡´åº”ç”¨å¡é¡¿',
    threshold: 10,
  },
  {
    path: ['ipc_binder', 'avg_latency'],
    issueName: 'IPC Binder å¹³å‡å»¶è¿Ÿè¿‡é«˜',
    description: 'IPC Binder è¿›ç¨‹é—´é€šä¿¡çš„å¹³å‡å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼ï¼Œå¯èƒ½å½±å“åº”ç”¨å“åº”é€Ÿåº¦',
    threshold: 50,
    format: (v) => v.toFixed(2),
  },
  {
    path: ['ipc_binder', 'max_latency'],
    issueName: 'IPC Binder æœ€å¤§å»¶è¿Ÿè¿‡é«˜',
    description: 'IPC Binder è¿›ç¨‹é—´é€šä¿¡çš„æœ€å¤§å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼ï¼Œå¯èƒ½å¯¼è‡´åº”ç”¨å‡ºç°æ˜æ˜¾å¡é¡¿',
    threshold: 100,
    format: (v) => v.toFixed(2),
  },
];

const formatFaultValue = (v: number): string => {
  if (v >= 1000000) return (v / 1000000).toFixed(1) + 'M';
  if (v >= 1000) return (v / 1000).toFixed(1) + 'K';
  return v.toLocaleString();
};

const getNested = (obj: any, path: string[]): unknown => {
  let cur = obj;
  for (const p of path) {
    if (cur == null) return undefined;
    cur = cur[p];
  }
  return cur;
};

// è·å–æ­¥éª¤çš„æ‰€æœ‰é—®é¢˜åˆ—è¡¨
const getIssuesForStep = (item: SummaryItem): IssueRow[] => {
  const issues: IssueRow[] = [];

  // 1. ç©ºåˆ·å¸§ï¼šå æ¯” > 10% æ˜¾ç¤ºï¼Œ> 50% ä¸¥é‡ï¼Œ10-50% ä¸­ç­‰
  if (item.empty_frame) {
    const percentage = parsePercentage(item.empty_frame.percentage);
    if (percentage > 10) {
      const severity: 'ä¸¥é‡' | 'ä¸­ç­‰' = percentage > 50 ? 'ä¸¥é‡' : 'ä¸­ç­‰';
      issues.push({
        issue: `ç©ºåˆ·å¸§å æ¯”è¿‡é«˜ (${item.empty_frame.percentage ?? '0.00%'})`,
        detail: `ç©ºåˆ·å¸§æ•°: ${item.empty_frame.count ?? 0}, å æ¯”: ${item.empty_frame.percentage ?? '0.00%'}`,
        severity,
      });
    }
  }

  // 2. æ•…éšœæ ‘ï¼šè¶…è¿‡é˜ˆå€¼çš„æ˜¾ç¤º
  if (item.fault_tree) {
    const ft = item.fault_tree as any;

    // è½¯è§£ç ï¼šå¸ƒå°”å€¼å•ç‹¬å¤„ç†
    const avCodec = ft.av_codec;
    if (avCodec && avCodec.soft_decoder === true) {
      issues.push({
        issue: 'éŸ³è§†é¢‘ä½¿ç”¨è½¯è§£ç ',
        detail: 'æ£€æµ‹åˆ°ä½¿ç”¨è½¯è§£ç å™¨è¿›è¡Œè§†é¢‘è§£ç ï¼Œè½¯è§£ç æ€§èƒ½è¾ƒå·®ï¼Œå»ºè®®ä½¿ç”¨ç¡¬è§£ç ä»¥æå‡æ€§èƒ½',
        severity: 'ä¸­ç­‰',
      });
    }

    for (const { path, issueName, description, threshold, format } of FAULT_THRESHOLDS) {
      const raw = getNested(ft, path);
      if (typeof raw !== 'number') continue;
      if (raw <= threshold) continue;

      const valueStr = format ? format(raw) : formatFaultValue(raw);
      const thresholdStr = format ? format(threshold) : formatFaultValue(threshold);
      const severity: 'ä¸¥é‡' | 'ä¸­ç­‰' = raw > threshold * 2 ? 'ä¸¥é‡' : 'ä¸­ç­‰';
      issues.push({
        issue: `${issueName} (å½“å‰å€¼: ${valueStr})`,
        detail: `${description}ã€‚å½“å‰å€¼: ${valueStr}, é˜ˆå€¼: ${thresholdStr}`,
        severity,
      });
    }
  }

  // 3. Image è¶…å°ºå¯¸ï¼šè¶…å°ºå¯¸æ•°é‡ > 0 æˆ–é¢å¤–å†…å­˜ > 10MB æ˜¾ç¤º
  if (item.image_oversize) {
    const exceedCount = item.image_oversize.exceed_count ?? 0;
    const excessMemory = item.image_oversize.total_excess_memory_mb ?? 0;
    if (exceedCount > 0 || excessMemory > 10) {
      const severity: 'ä¸¥é‡' | 'ä¸­ç­‰' = excessMemory > 50 ? 'ä¸¥é‡' : 'ä¸­ç­‰';
      issues.push({
        issue: `Image è¶…å°ºå¯¸é—®é¢˜ (${exceedCount} ä¸ª, ${excessMemory.toFixed(2)} MB)`,
        detail: `è¶…å°ºå¯¸æ•°é‡: ${exceedCount}, é¢å¤–å†…å­˜: ${excessMemory.toFixed(2)} MB`,
        severity,
      });
    }
  }

  // 4. ç»„ä»¶æ ‘ï¼šæœªä¸Šæ ‘å æ¯” > 20% æ˜¾ç¤º
  if (item.component_tree) {
    const offTreeRatio = (item.component_tree.off_tree_ratio ?? 0) * 100;
    if (offTreeRatio > 20) {
      const severity: 'ä¸¥é‡' | 'ä¸­ç­‰' = offTreeRatio > 50 ? 'ä¸¥é‡' : 'ä¸­ç­‰';
      issues.push({
        issue: `ç»„ä»¶æœªä¸Šæ ‘å æ¯”è¿‡é«˜ (${offTreeRatio.toFixed(2)}%)`,
        detail: `æœªä¸Šæ ‘èŠ‚ç‚¹: ${item.component_tree.off_tree_nodes ?? 0}, å æ¯”: ${offTreeRatio.toFixed(2)}%`,
        severity,
      });
    }
  }

  // 5. ç»„ä»¶å¤ç”¨ï¼šå¤ç”¨ç‡ < 30% æ˜¾ç¤º
  if (item.component_reuse) {
    const reusabilityRatio = (item.component_reuse.reusability_ratio ?? 0) * 100;
    if (reusabilityRatio < 30 && (item.component_reuse.total_builds ?? 0) > 0) {
      const severity: 'ä¸¥é‡' | 'ä¸­ç­‰' = reusabilityRatio < 10 ? 'ä¸¥é‡' : 'ä¸­ç­‰';
      issues.push({
        issue: `ç»„ä»¶å¤ç”¨ç‡è¿‡ä½ (${reusabilityRatio.toFixed(2)}%)`,
        detail: `å¤ç”¨ç‡: ${reusabilityRatio.toFixed(2)}%, æ€»æ„å»º: ${item.component_reuse.total_builds ?? 0}, å¤ç”¨æ„å»º: ${item.component_reuse.recycled_builds ?? 0}`,
        severity,
      });
    }
  }

  // æŠ€æœ¯æ ˆå’Œæ—¥å¿—ä¸æ˜¾ç¤ºï¼ˆå·²æ’é™¤ï¼‰

  return issues;
};

// è·å–ä¸¥é‡ç¨‹åº¦çš„æ ‡ç­¾ç±»å‹
const getSeverityType = (severity: string): 'danger' | 'warning' | 'info' => {
  if (severity === 'ä¸¥é‡') return 'danger';
  if (severity === 'ä¸­ç­‰') return 'warning';
  return 'info';
};
</script>

<style scoped>
.summary-overview-container {
  padding: 20px;
  background: #f5f7fa;
}

.summary-header {
  margin-bottom: 20px;
}

.summary-header h2 {
  margin: 0 0 8px 0;
  font-size: 24px;
  font-weight: 600;
  color: #303133;
}

.summary-desc {
  margin: 0;
  color: #606266;
  font-size: 14px;
}

.step-nav {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
}

.step-nav-label {
  font-size: 13px;
  color: #606266;
}

.step-section {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  margin-bottom: 20px;
}

.step-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.step-tag {
  padding: 4px 10px;
  border-radius: 999px;
  background: #eef2ff;
  color: #4c6fff;
  font-size: 12px;
  font-weight: 600;
}

.step-name {
  font-size: 15px;
  font-weight: 500;
  color: #303133;
}

.summary-empty {
  margin-top: 40px;
}

.rules-card {
  margin-bottom: 20px;
  border: 1px solid #e4e7ed;
}

.rules-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  color: #303133;
}

.rules-content {
  padding-top: 8px;
}

.rule-item {
  margin-bottom: 12px;
  font-size: 14px;
  line-height: 1.6;
  color: #606266;
}

.rule-item strong {
  color: #303133;
  margin-right: 8px;
}

.rule-section {
  margin-bottom: 16px;
}

.rule-section-title {
  display: block;
  color: #303133;
  margin-bottom: 8px;
  font-size: 14px;
}

.rule-subsection {
  margin-left: 0;
  padding-left: 0;
}

.rule-subtitle {
  font-size: 13px;
  color: #909399;
  margin-bottom: 12px;
  font-style: italic;
}

.rule-category {
  margin-bottom: 16px;
  padding-left: 16px;
  border-left: 3px solid #e4e7ed;
}

.rule-category strong {
  display: block;
  color: #303133;
  margin-bottom: 8px;
  font-size: 13px;
}

.rule-list {
  margin: 0;
  padding-left: 20px;
  list-style-type: disc;
}

.rule-list li {
  margin-bottom: 6px;
  font-size: 13px;
  color: #606266;
  line-height: 1.5;
}

:deep(.el-table) {
  font-size: 14px;
}

:deep(.el-table th) {
  background-color: #f5f7fa;
  font-weight: 600;
}

:deep(.el-table .el-table__row:hover) {
  background-color: #f5f7fa;
}
</style>
